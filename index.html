<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ù„Ù„Ù…Ø±ÙƒØ¨Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            transition: background-color 0.3s, color 0.3s ease;
            min-height: 100vh;
        }
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark-mode .bg-white { background-color: #2d3748; }
        .dark-mode .bg-gray-100 { background-color: #1a202c; }
        .dark-mode .text-gray-700 { color: #e2e8f0; }
        .dark-mode .bg-indigo-600 { background-color: #667eea; }
        .expired { background-color: #fee2e2; }
        .warning { background-color: #fef3c7; }
        .stats-card { transition: transform 0.3s; }
        .stats-card:hover { transform: scale(1.05); }
        .navbar { background-color: #1e3a8a; }
        .search-input { transition: width 0.3s; }
        .search-input:focus { width: 300px; }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .logo {
            width: 80px;
            margin: 0 auto;
        }
        .hidden { display: none; }
        .action-btn {
            transition: all 0.3s;
            cursor: pointer;
        }
        .action-btn:hover {
            transform: translateY(-2px);
        }
        .floating-buttons {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 50;
        }
        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .floating-btn:hover {
            transform: scale(1.1);
        }
        .company-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .company-ibn-awf { background-color: #FFE4E1; color: #8B0000; }
        .company-east-drelig { background-color: #E6E6FA; color: #4B0082; }
        .company-algeria-ham { background-color: #F0FFF0; color: #006400; }
        .company-ibrahim { background-color: #FFF0F5; color: #C71585; }
        .company-personal { background-color: #E5E7EB; color: #1F2937; }
        .filter-btn {
            transition: all 0.3s;
            cursor: pointer;
        }
        .filter-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px currentColor;
        }
        .print-btn {
            background-color: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
        }
        .print-btn:hover {
            background-color: #4b5563;
            transform: translateY(-2px);
        }
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: white !important;
                color: black !important;
            }
            table {
                width: 100% !important;
                font-size: 12px !important;
            }
            .bg-indigo-600, .bg-red-600 {
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen" class="login-container hidden">
        <div class="flex flex-col items-center mb-6">
            <img src="https://brandlogos.net/wp-content/uploads/2022/10/sym_-_sanyang_motor-logo_brandlogos.net_mre4v.png" alt="Logo" class="logo mb-4">
            <h2 class="text-2xl font-bold text-gray-800">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        </div>
        <form id="loginForm">
            <div class="mb-4">
                <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
            </div>
            <div class="flex items-center justify-between">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </div>
        </form>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div id="mainContent" class="hidden">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav id="navbar" class="navbar p-4 text-white shadow-lg no-print">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <img src="https://brandlogos.net/wp-content/uploads/2022/10/sym_-_sanyang_motor-logo_brandlogos.net_mre4v.png" alt="Logo" class="h-12 w-auto">
                    <span class="text-xl font-bold hidden md:block">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle" class="text-white hover:text-blue-300 p-2 rounded-full">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="logout" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded transition">
                        <i class="fas fa-sign-out-alt mr-1"></i> <span class="hidden md:inline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="container mx-auto p-6 max-w-6xl">
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 no-print">
                <div class="bg-white p-4 rounded-lg shadow-lg stats-card">
                    <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-car mr-2"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</h3>
                    <p id="totalVehicles" class="text-2xl font-bold text-indigo-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-lg stats-card">
                    <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-exclamation-triangle mr-2"></i> Ù…Ø±Ø§Ù‚Ø¨Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</h3>
                    <p id="expiringInspections" class="text-2xl font-bold text-yellow-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-lg stats-card">
                    <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-calendar-times mr-2"></i> Ù…Ø±Ø§Ù‚Ø¨Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ©</h3>
                    <p id="expiredInspections" class="text-2xl font-bold text-red-600">0</p>
                </div>
            </div>

            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 no-print">
                <i class="fas fa-car-crash mr-2"></i> Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ù„Ù„Ù…Ø±ÙƒØ¨Ø§Øª
            </h1>

            <!-- Ø²Ø± ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel -->
            <div class="flex justify-end mb-4 no-print">
                <button id="exportExcel" class="bg-purple-600 text-white p-3 rounded hover:bg-purple-700">
                    <i class="fas fa-file-excel mr-2"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                </button>
                <button id="addInspectionBtn" class="bg-indigo-600 text-white p-3 rounded hover:bg-indigo-700 ml-2">
                    <i class="fas fa-plus mr-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨Ø©
                </button>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ© -->
            <div class="bg-white p-4 rounded-lg shadow mb-6 no-print">
                <h3 class="text-lg font-semibold text-gray-700 mb-3"><i class="fas fa-filter mr-2"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ©</h3>
                <div class="flex flex-wrap gap-2">
                    <button data-company="all" class="filter-btn active bg-gray-200 text-gray-800 px-4 py-2 rounded-full">
                        Ø§Ù„ÙƒÙ„
                    </button>
                    <button data-company="Ø§Ø¨Ù† Ø¹ÙˆÙ" class="filter-btn bg-red-100 text-red-800 px-4 py-2 rounded-full">
                        Ø§Ø¨Ù† Ø¹ÙˆÙ
                    </button>
                    <button data-company="Ø§ÙŠØ³Øª Ø¯Ø±ÙŠÙ„ÙŠÙ‚" class="filter-btn bg-purple-100 text-purple-800 px-4 py-2 rounded-full">
                        Ø§ÙŠØ³Øª Ø¯Ø±ÙŠÙ„ÙŠÙ‚
                    </button>
                    <button data-company="Ø§Ù„Ø¬ÙŠØ±ÙŠØ§ Ù‡Ø§Ù… Ù…ÙˆØªÙˆØ±Ø²" class="filter-btn bg-green-100 text-green-800 px-4 py-2 rounded-full">
                        Ø§Ù„Ø¬ÙŠØ±ÙŠØ§ Ù‡Ø§Ù… Ù…ÙˆØªÙˆØ±Ø²
                    </button>
                    <button data-company="Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…" class="filter-btn bg-pink-100 text-pink-800 px-4 py-2 rounded-full">
                        Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…
                    </button>
                    <button data-company="Ø¹ØªØ§Ø¯ Ø´Ø®ØµÙŠ" class="filter-btn bg-gray-100 text-gray-800 px-4 py-2 rounded-full">
                        Ø¹ØªØ§Ø¯ Ø´Ø®ØµÙŠ
                    </button>
                </div>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4 no-print">
                    <h2 class="text-xl font-semibold text-gray-700"><i class="fas fa-car-crash mr-2"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©</h2>
                    <div>
                        <button onclick="printTable('inspectionsTable', 'Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©')" class="print-btn">
                            <i class="fas fa-print mr-2"></i> Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                        <input type="text" id="inspectionSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„..." class="p-2 border rounded search-input w-40 focus:w-64">
                    </div>
                </div>
                <div id="inspectionsTable">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-indigo-600 text-white">
                                <th class="p-3">Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                <th class="p-3">Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th>
                                <th class="p-3">Ø§Ù„Ù…Ù„ÙƒÙŠØ©</th>
                                <th class="p-3">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</th>
                                <th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</th>
                                <th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                                <th class="p-3">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th class="p-3 no-print">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                <th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="inspectionsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        // Firebase configuration (using the one provided in the original code)
        const firebaseConfig = {
            apiKey: "AIzaSyCq965bxM1CEYAsTlBuxk8cH8iiOL2EiZY",
            authDomain: "issam-bf5e3.firebaseapp.com",
            databaseURL: "https://issam-bf5e3-default-rtdb.firebaseio.com",
            projectId: "issam-bf5e3",
            storageBucket: "issam-bf5e3.appspot.com",
            messagingSenderId: "87131430026",
            appId: "1:87131430026:web:5ad0e5614839c36dac6173",
            measurementId: "G-15XBD6NWQ2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let vehicles = [];
        let inspections = [];
        let currentCompanyFilter = 'all';

        // Get references to the login and main content screens
        const loginScreen = document.getElementById('loginScreen');
        const mainContent = document.getElementById('mainContent');

        // Function to handle printing table content
        function printTable(tableId, title) {
            const printContents = document.getElementById(tableId).innerHTML;
            const originalContents = document.body.innerHTML;
            
            document.body.innerHTML = `
                <h1 style="text-align: center; margin-bottom: 20px;">${title}</h1>
                ${printContents}
                <div style="text-align: left; margin-top: 20px; font-size: 12px;">
                    ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ: ${new Date().toLocaleString()}
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContents;
            location.reload(); // Reload to restore original page state
        }

        // Logout functionality
        document.getElementById('logout').addEventListener('click', () => {
            signOut(auth).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
                    timer: 1500,
                    showConfirmButton: false
                });
                // Hide main content and show login screen
                mainContent.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }).catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
                    text: error.message
                });
            });
        });

        // Dark mode toggle functionality
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        });

        // Apply dark mode preference on load
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // Load data from Firebase Realtime Database
        async function loadData() {
            try {
                const vehiclesSnapshot = await get(ref(database, 'vehicles'));
                vehicles = vehiclesSnapshot.val() ? Object.entries(vehiclesSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];

                const inspectionsSnapshot = await get(ref(database, 'SCANER'));
                inspections = inspectionsSnapshot.val() ? Object.entries(inspectionsSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];

                renderInspectionsTable();
                updateStats();
            } catch (error) {
                console.error("Error fetching data:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£',
                    text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message
                });
            }
        }

        // Update statistics cards
        function updateStats() {
            document.getElementById('totalVehicles').textContent = vehicles.length;
            
            const expiringInspectionsCount = inspections.filter(ins => {
                const daysRemaining = getDaysRemaining(ins.endDate);
                return daysRemaining <= 30 && daysRemaining >= 0;
            }).length;
            document.getElementById('expiringInspections').textContent = expiringInspectionsCount;
            
            const expiredInspectionsCount = inspections.filter(ins => {
                const daysRemaining = getDaysRemaining(ins.endDate);
                return daysRemaining < 0;
            }).length;
            document.getElementById('expiredInspections').textContent = expiredInspectionsCount;
        }

        // Filter by company functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCompanyFilter = btn.dataset.company;
                renderInspectionsTable();
            });
        });

        // Add new inspection functionality (with vehicle search)
        document.getElementById('addInspectionBtn').addEventListener('click', () => {
            Swal.fire({
                title: 'Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙ‚Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©',
                html: `
                    <input type="text" id="swalVehicleSearchInput" class="swal2-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙƒØ¨Ø©..." dir="rtl">
                    <select id="swalInspectionVehicle" class="swal2-select" required dir="rtl">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</option>
                        <!-- Options populated dynamically -->
                    </select>
                    <select id="swalInspectionType" class="swal2-select" required dir="rtl">
                        <option value="Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆØ±ÙŠØ©">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆØ±ÙŠØ©</option>
                        <option value="Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©</option>
                    </select>
                    <input type="date" id="swalInspectionDate" class="swal2-input" required dir="rtl">
                    <input type="date" id="swalInspectionEndDate" class="swal2-input" required dir="rtl">
                    <textarea id="swalInspectionNotes" class="swal2-textarea" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" dir="rtl"></textarea>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Ø­ÙØ¸',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                didOpen: () => {
                    const searchInput = document.getElementById('swalVehicleSearchInput');
                    const vehicleSelect = document.getElementById('swalInspectionVehicle');

                    // Function to render vehicle options based on search term
                    const renderVehicleOptions = (searchTerm = '') => {
                        vehicleSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</option>'; // Keep placeholder

                        const filtered = vehicles.filter(v =>
                            v.plateNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (v.brand && v.brand.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (v.model && v.model.toLowerCase().includes(searchTerm.toLowerCase()))
                        );

                        filtered.forEach(v => {
                            const option = document.createElement('option');
                            option.value = v.plateNumber;
                            option.textContent = `${v.plateNumber} (${v.brand || ''} ${v.model || ''})`;
                            vehicleSelect.appendChild(option);
                        });
                    };

                    // Initial render of all vehicles
                    renderVehicleOptions();

                    // Add event listener for search input to filter options
                    searchInput.addEventListener('input', (event) => {
                        renderVehicleOptions(event.target.value);
                    });

                    // Set initial selection if an existing plate number matches
                    // This might be useful if editing, but for adding, it's fresh.
                    // If the user types a full plate number and it exists, select it automatically.
                    searchInput.addEventListener('change', () => {
                        const exactMatch = vehicles.find(v => v.plateNumber === searchInput.value);
                        if (exactMatch) {
                            vehicleSelect.value = exactMatch.plateNumber;
                        } else {
                            vehicleSelect.value = ''; // Clear if no exact match
                        }
                    });

                },
                preConfirm: async () => {
                    const plateNumber = document.getElementById('swalInspectionVehicle').value;
                    const inspectionType = document.getElementById('swalInspectionType').value;
                    const inspectionDate = document.getElementById('swalInspectionDate').value;
                    const endDate = document.getElementById('swalInspectionEndDate').value;
                    const notes = document.getElementById('swalInspectionNotes').value || '';

                    if (!plateNumber || !inspectionDate || !endDate) {
                        Swal.showValidationMessage('Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ù„Ù…Ø±ÙƒØ¨Ø©ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡');
                        return false;
                    }

                    // Validate if the selected plate number actually exists in the vehicles array
                    const selectedVehicle = vehicles.find(v => v.plateNumber === plateNumber);
                    if (!selectedVehicle) {
                        Swal.showValidationMessage('Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙƒØ¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©.');
                        return false;
                    }

                    const inspection = {
                        plateNumber: plateNumber,
                        inspectionType: inspectionType,
                        inspectionDate: inspectionDate,
                        endDate: endDate,
                        notes: notes
                    };

                    const id = Date.now().toString(); // Simple unique ID based on timestamp

                    try {
                        await set(ref(database, 'SCANER/' + id), inspection);
                        inspections.push({ id, ...inspection }); // Add to local array
                        renderInspectionsTable(); // Re-render table
                        updateStats(); // Update statistics
                        return true;
                    } catch (error) {
                        Swal.showValidationMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ' + error.message);
                        return false;
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©',
                        text: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!'
                    });
                }
            });
        });

        // Calculate days remaining until expiry
        function getDaysRemaining(endDate) {
            const today = new Date();
            const end = new Date(endDate);
            const diffTime = end - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Export data to Excel
        document.getElementById('exportExcel').addEventListener('click', () => {
            const inspectionData = inspections.map(inspection => {
                const vehicle = vehicles.find(v => v.plateNumber === inspection.plateNumber);
                const daysRemaining = getDaysRemaining(inspection.endDate);
                let status = '';
                
                if (daysRemaining <= 0) {
                    status = 'Ù…Ù†ØªÙ‡ÙŠ';
                } else if (daysRemaining <= 30) {
                    status = 'Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
                } else {
                    status = 'ÙØ¹Ø§Ù„';
                }

                return {
                    'Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„': inspection.plateNumber,
                    'Ø§Ù„Ù…Ø±ÙƒØ¨Ø©': vehicle ? `${vehicle.brand || ''} ${vehicle.model || ''}` : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    'Ø§Ù„Ù…Ù„ÙƒÙŠØ©': vehicle ? vehicle.company : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©': inspection.inspectionType,
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©': inspection.inspectionDate,
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡': inspection.endDate,
                    'Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©': daysRemaining,
                    'Ø§Ù„Ø­Ø§Ù„Ø©': status,
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': inspection.notes || '-'
                };
            });

            const worksheet = XLSX.utils.json_to_sheet(inspectionData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Inspections Data');
            XLSX.writeFile(workbook, 'inspections_data.xlsx');
        });

        // Filter table by search input
        document.getElementById('inspectionSearch').addEventListener('input', () => renderInspectionsTable());

        // Get CSS class for company badge
        function getCompanyBadgeClass(company) {
            switch(company) {
                case 'Ø§Ø¨Ù† Ø¹ÙˆÙ': return 'company-ibn-awf';
                case 'Ø§ÙŠØ³Øª Ø¯Ø±ÙŠÙ„ÙŠÙ‚': return 'company-east-drelig';
                case 'Ø§Ù„Ø¬ÙŠØ±ÙŠØ§ Ù‡Ø§Ù… Ù…ÙˆØªÙˆØ±Ø²': return 'company-algeria-ham';
                case 'Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…': return 'company-ibrahim';
                case 'Ø¹ØªØ§Ø¯ Ø´Ø®ØµÙŠ': return 'company-personal';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Render (or re-render) the inspections table
        function renderInspectionsTable() {
            const searchTerm = document.getElementById('inspectionSearch').value.toLowerCase();
            const inspectionsTableBody = document.getElementById('inspectionsTableBody');
            inspectionsTableBody.innerHTML = '';

            const filteredInspections = inspections
                .filter(ins => ins.plateNumber.toLowerCase().includes(searchTerm))
                .filter(ins => {
                    if (currentCompanyFilter === 'all') return true;
                    const vehicle = vehicles.find(v => v.plateNumber === ins.plateNumber);
                    return vehicle && vehicle.company === currentCompanyFilter;
                });

            filteredInspections.forEach(inspection => {
                const vehicle = vehicles.find(v => v.plateNumber === inspection.plateNumber);
                const daysRemaining = getDaysRemaining(inspection.endDate);
                let status = '';
                let statusClass = '';
                let statusEmoji = ''; // Added for emoji

                if (daysRemaining <= 0) {
                    status = 'Ù…Ù†ØªÙ‡ÙŠ';
                    statusClass = 'bg-red-100 text-red-800';
                    statusEmoji = 'ğŸ”´'; // Red circle emoji
                } else if (daysRemaining <= 30) {
                    status = 'Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusEmoji = 'ï¿½'; // Yellow circle emoji
                } else {
                    status = 'ÙØ¹Ø§Ù„';
                    statusClass = 'bg-green-100 text-green-800';
                    statusEmoji = 'ğŸŸ¢'; // Green circle emoji
                }

                const row = document.createElement('tr');
                if (daysRemaining <= 0) {
                    row.classList.add('expired');
                } else if (daysRemaining <= 30) {
                    row.classList.add('warning');
                }

                row.innerHTML = `
                    <td class="p-3">${inspection.plateNumber}</td>
                    <td class="p-3">${vehicle ? `${vehicle.brand || ''} ${vehicle.model || ''}` : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                    <td class="p-3">
                        ${vehicle ? `
                            <span class="company-badge ${getCompanyBadgeClass(vehicle.company)}">
                                ${vehicle.company}
                            </span>
                        ` : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                    </td>
                    <td class="p-3">${inspection.inspectionType}</td>
                    <td class="p-3">${inspection.inspectionDate}</td>
                    <td class="p-3">${inspection.endDate}</td>
                    <td class="p-3 text-center"><span class="px-2 py-1 rounded-full text-xs ${statusClass}">${daysRemaining}</span></td>
                    <td class="p-3 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                            ${statusEmoji} ${status}
                        </span>
                    </td>
                    <td class="p-3">${inspection.notes || '-'}</td>
                    <td class="p-3 no-print">
                        <button onclick="editInspection('${inspection.id}')" class="action-btn text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteInspection('${inspection.id}')" class="action-btn text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                inspectionsTableBody.appendChild(row);
            });
        }

        // Edit inspection functionality
        window.editInspection = function(id) {
            const inspection = inspections.find(ins => ins.id === id);
            if (!inspection) return;

            Swal.fire({
                title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©',
                html: `
                    <input type="text" id="editVehicleSearchInput" class="swal2-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙƒØ¨Ø©..." dir="rtl">
                    <select id="editInspectionPlate" class="swal2-select" required dir="rtl">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</option>
                        <!-- Options populated dynamically -->
                    </select>
                    <select id="editInspectionType" class="swal2-select" dir="rtl">
                        <option value="Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆØ±ÙŠØ©" ${inspection.inspectionType === 'Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆØ±ÙŠØ©' ? 'selected' : ''}>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆØ±ÙŠØ©</option>
                        <option value="Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©" ${inspection.inspectionType === 'Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©' ? 'selected' : ''}>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©</option>
                    </select>
                    <input type="date" id="editInspectionDate" class="swal2-input" value="${inspection.inspectionDate}" dir="rtl">
                    <input type="date" id="editInspectionEndDate" class="swal2-input" value="${inspection.endDate}" dir="rtl">
                    <textarea id="editInspectionNotes" class="swal2-textarea" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" dir="rtl">${inspection.notes || ''}</textarea>
                `,
                showCancelButton: true,
                confirmButtonText: 'Ø­ÙØ¸',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                didOpen: () => {
                    const searchInput = document.getElementById('editVehicleSearchInput');
                    const vehicleSelect = document.getElementById('editInspectionPlate');

                    const renderEditVehicleOptions = (searchTerm = '') => {
                        vehicleSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</option>';
                        const filtered = vehicles.filter(v =>
                            v.plateNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (v.brand && v.brand.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (v.model && v.model.toLowerCase().includes(searchTerm.toLowerCase()))
                        );
                        filtered.forEach(v => {
                            const option = document.createElement('option');
                            option.value = v.plateNumber;
                            option.textContent = `${v.plateNumber} (${v.brand || ''} ${v.model || ''})`;
                            vehicleSelect.appendChild(option);
                        });
                        // Select the current inspection's vehicle after rendering options
                        if (inspection.plateNumber) {
                            vehicleSelect.value = inspection.plateNumber;
                        }
                    };

                    renderEditVehicleOptions(); // Initial render for edit modal

                    searchInput.addEventListener('input', (event) => {
                        renderEditVehicleOptions(event.target.value);
                    });

                    searchInput.addEventListener('change', () => {
                        const exactMatch = vehicles.find(v => v.plateNumber === searchInput.value);
                        if (exactMatch) {
                            vehicleSelect.value = exactMatch.plateNumber;
                        } else {
                            vehicleSelect.value = '';
                        }
                    });

                    // Set the search input value to the current vehicle's plate number initially
                    searchInput.value = inspection.plateNumber;
                },
                preConfirm: async () => {
                    const plateNumber = document.getElementById('editInspectionPlate').value;
                    const inspectionType = document.getElementById('editInspectionType').value;
                    const inspectionDate = document.getElementById('editInspectionDate').value;
                    const endDate = document.getElementById('editInspectionEndDate').value;
                    const notes = document.getElementById('editInspectionNotes').value || '';

                    if (!plateNumber || !inspectionDate || !endDate) {
                        Swal.showValidationMessage('Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ù„Ù…Ø±ÙƒØ¨Ø©ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡');
                        return false;
                    }

                    const selectedVehicle = vehicles.find(v => v.plateNumber === plateNumber);
                    if (!selectedVehicle) {
                        Swal.showValidationMessage('Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙƒØ¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©.');
                        return false;
                    }

                    const updatedInspection = {
                        plateNumber: plateNumber,
                        inspectionType: inspectionType,
                        inspectionDate: inspectionDate,
                        endDate: endDate,
                        notes: notes
                    };

                    try {
                        await set(ref(database, 'SCANER/' + id), updatedInspection);
                        const index = inspections.findIndex(ins => ins.id === id);
                        inspections[index] = { id, ...updatedInspection };
                        renderInspectionsTable();
                        updateStats();
                        Swal.fire('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„!', 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ø®Ø·Ø£',
                            text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ' + error.message
                        });
                    }
                }
            });
        };

        // Delete inspection functionality
        window.deleteInspection = async function(id) {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù!',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await remove(ref(database, 'SCANER/' + id));
                        inspections = inspections.filter(ins => ins.id !== id);
                        renderInspectionsTable();
                        updateStats();
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù!', 'ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ø®Ø·Ø£',
                            text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message
                        });
                    }
                }
            });
        };

        // Login form submission handler
        document.getElementById('loginForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state observer will handle showing main content
                Swal.fire({
                    icon: 'success',
                    title: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!',
                    showConfirmButton: false,
                    timer: 1500
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                    text: error.message
                });
            }
        });

        // Load data on authentication state change
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, hide login screen and show main content
                loginScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                loadData(); // Load application data
            } else {
                // No user is signed in, show login screen and hide main content
                mainContent.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
