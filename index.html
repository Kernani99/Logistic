<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة تأمينات وصيانة المركبات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            transition: background-color 0.3s, color 0.3s ease;
            min-height: 100vh;
        }
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark-mode .bg-white { background-color: #2d3748; }
        .dark-mode .bg-gray-100 { background-color: #1a202c; }
        .dark-mode .text-gray-700 { color: #e2e8f0; }
        .dark-mode .bg-blue-600 { background-color: #3182ce; }
        .dark-mode .bg-green-600 { background-color: #38a169; }
        .dark-mode .bg-yellow-600 { background-color: #d69e2e; }
        .dark-mode .bg-indigo-600 { background-color: #667eea; }
        .expired { background-color: #fee2e2; }
        .warning { background-color: #fef3c7; }
        .stats-card { transition: transform 0.3s; }
        .stats-card:hover { transform: scale(1.05); }
        .navbar { background-color: #1e3a8a; }
        .search-input { transition: width 0.3s; }
        .search-input:focus { width: 300px; }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .logo {
            width: 80px;
            margin: 0 auto;
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- شريط التنقل -->
    <nav id="navbar" class="navbar p-4 text-white shadow-lg hidden">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <img src="https://via.placeholder.com/40" alt="Logo" class="mr-2">
                <span class="text-xl font-bold">إدارة المركبات</span>
            </div>
            <div class="space-x-4">
                <button id="dashboardNav" class="hover:text-blue-300"><i class="fas fa-car mr-1"></i> الإدارة</button>
                <button id="statsNav" class="hover:text-blue-300"><i class="fas fa-chart-bar mr-1"></i> الإحصائيات</button>
                <button id="darkModeToggle" class="text-white hover:text-blue-300">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="logout" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">
                    <i class="fas fa-sign-out-alt mr-1"></i> تسجيل الخروج
                </button>
            </div>
        </div>
    </nav>

    <!-- واجهة تسجيل الدخول -->
    <div id="loginView" class="login-container">
        <img src="https://via.placeholder.com/80" alt="Logo" class="logo mb-4">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">
            <i class="fas fa-lock mr-2"></i> تسجيل الدخول
        </h1>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="username" class="block text-gray-700">اسم المستخدم</label>
                <input type="text" id="username" placeholder="أدخل اسم المستخدم" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label for="password" class="block text-gray-700">كلمة المرور</label>
                <input type="password" id="password" placeholder="أدخل كلمة المرور" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition duration-300">
                <i class="fas fa-sign-in-alt mr-2"></i> تسجيل الدخول
            </button>
        </form>
    </div>

    <!-- واجهة الإدارة -->
    <div id="dashboardView" class="container mx-auto p-6 max-w-6xl hidden">
        <!-- قسم الإحصائيات -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-lg stats-card">
                <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-car mr-2"></i> عدد المركبات</h3>
                <p id="totalVehicles" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-lg stats-card">
                <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-exclamation-triangle mr-2"></i> تأمينات قريبة من الانتهاء</h3>
                <p id="expiringInsurances" class="text-2xl font-bold text-yellow-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-lg stats-card">
                <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-oil-can mr-2"></i> صيانات زيت قريبة</h3>
                <p id="upcomingMaintenances" class="text-2xl font-bold text-orange-600">0</p>
            </div>
        </div>

        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            <i class="fas fa-car-side mr-2"></i> إدارة تأمينات وصيانة المركبات
        </h1>

        <!-- زر تصدير إلى Excel -->
        <div class="flex justify-end mb-4">
            <button id="exportExcel" class="bg-purple-600 text-white p-3 rounded hover:bg-purple-700">
                <i class="fas fa-file-excel mr-2"></i> تصدير إلى Excel
            </button>
        </div>

        <!-- نموذج إضافة مركبة -->
        <div id="vehicles" class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4"><i class="fas fa-plus-circle mr-2"></i> إضافة مركبة</h2>
            <form id="vehicleForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="brand" placeholder="العلامة التجارية" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="text" id="model" placeholder="النوع" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="text" id="plateNumber" placeholder="رقم التسجيل" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="text" id="driverName" placeholder="اسم السائق" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <select id="vehicleType" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="سيارة">سيارة</option>
                    <option value="شاحنة">شاحنة</option>
                </select>
                <button type="submit" class="col-span-1 md:col-span-2 bg-blue-600 text-white p-3 rounded hover:bg-blue-700">
                    <i class="fas fa-save mr-2"></i> إضافة المركبة
                </button>
            </form>
        </div>

        <!-- نموذج إضافة تأمين -->
        <div id="insurances" class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4"><i class="fas fa-shield-alt mr-2"></i> إضافة تأمين</h2>
            <form id="insuranceForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <select id="vehicleSelect" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">اختر المركبة</option>
                </select>
                <input type="date" id="insuranceStart" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="date" id="insuranceEnd" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" class="col-span-1 md:col-span-2 bg-green-600 text-white p-3 rounded hover:bg-green-700">
                    <i class="fas fa-save mr-2"></i> إضافة تأمين
                </button>
            </form>
        </div>

        <!-- نموذج إضافة صيانة زيت -->
        <div id="maintenance" class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4"><i class="fas fa-oil-can mr-2"></i> إضافة صيانة زيت</h2>
            <form id="maintenanceForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <select id="maintenanceVehicleSelect" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">اختر المركبة</option>
                </select>
                <input type="date" id="oilChangeDate" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="number" id="currentMileage" placeholder="عداد المركبة الحالي (كم)" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="number" id="nextMileage" placeholder="عداد تغيير الزيت القادم (كم)" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" class="col-span-1 md:col-span-2 bg-yellow-600 text-white p-3 rounded hover:bg-yellow-700">
                    <i class="fas fa-save mr-2"></i> إضافة صيانة
                </button>
            </form>
        </div>

        <!-- نموذج إضافة صيانة قطع غيار -->
        <div id="spareParts" class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4"><i class="fas fa-tools mr-2"></i> إضافة صيانة قطع غيار</h2>
            <form id="sparePartsForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <select id="sparePartsVehicleSelect" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">اختر المركبة</option>
                </select>
                <input type="date" id="sparePartsDate" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="text" id="sparePartsNote" placeholder="ملاحظة (الغيار الذي تم تغييره)" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" class="col-span-1 md:col-span-2 bg-indigo-600 text-white p-3 rounded hover:bg-indigo-700">
                    <i class="fas fa-save mr-2"></i> إضافة صيانة قطع غيار
                </button>
            </form>
        </div>

        <!-- جدول المركبات -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700"><i class="fas fa-table mr-2"></i> قائمة المركبات</h2>
                <input type="text" id="vehicleSearch" placeholder="ابحث برقم التسجيل..." class="p-2 border rounded search-input w-40 focus:w-64">
            </div>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-600 text-white">
                        <th class="p-3">العلامة</th>
                        <th class="p-3">النوع</th>
                        <th class="p-3">رقم التسجيل</th>
                        <th class="p-3">السائق</th>
                        <th class="p-3">نوع المركبة</th>
                        <th class="p-3">تاريخ بداية التأمين</th>
                        <th class="p-3">تاريخ نهاية التأمين</th>
                        <th class="p-3">الأيام المتبقية</th>
                        <th class="p-3">الحالة</th>
                        <th class="p-3">إجراءات</th>
                    </tr>
                </thead>
                <tbody id="vehiclesTableBody"></tbody>
            </table>
        </div>

        <!-- جدول صيانة الزيوت -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700"><i class="fas fa-oil-can mr-2"></i> سجل صيانة الزيوت</h2>
                <input type="text" id="maintenanceSearch" placeholder="ابحث برقم التسجيل..." class="p-2 border rounded search-input w-40 focus:w-64">
            </div>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-yellow-600 text-white">
                        <th class="p-3">رقم التسجيل</th>
                        <th class="p-3">تاريخ تغيير الزيت</th>
                        <th class="p-3">عداد المركبة (كم)</th>
                        <th class="p-3">عداد التغيير القادم (كم)</th>
                        <th class="p-3">إجراءات</th>
                    </tr>
                </thead>
                <tbody id="maintenanceTableBody"></tbody>
            </table>
        </div>

        <!-- جدول صيانة قطع الغيار -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700"><i class="fas fa-tools mr-2"></i> سجل صيانة قطع الغيار</h2>
                <input type="text" id="sparePartsSearch" placeholder="ابحث برقم التسجيل..." class="p-2 border rounded search-input w-40 focus:w-64">
            </div>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-indigo-600 text-white">
                        <th class="p-3">رقم التسجيل</th>
                        <th class="p-3">تاريخ الصيانة</th>
                        <th class="p-3">ملاحظة (الغيار الذي تم تغييره)</th>
                        <th class="p-3">إجراءات</th>
                    </tr>
                </thead>
                <tbody id="sparePartsTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- واجهة الإحصائيات -->
    <div id="statsView" class="container mx-auto p-6 max-w-6xl hidden">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
            <i class="fas fa-chart-bar mr-2"></i> الإحصائيات المتقدمة
        </h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">عدد المركبات حسب النوع</h2>
                <canvas id="vehicleTypeChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">حالة التأمينات</h2>
                <canvas id="insuranceStatusChart"></canvas>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCq965bxM1CEYAsTlBuxk8cH8iiOL2EiZY",
            authDomain: "issam-bf5e3.firebaseapp.com",
            databaseURL: "https://issam-bf5e3-default-rtdb.firebaseio.com",
            projectId: "issam-bf5e3",
            storageBucket: "issam-bf5e3.appspot.com",
            messagingSenderId: "87131430026",
            appId: "1:87131430026:web:5ad0e5614839c36dac6173",
            measurementId: "G-15XBD6NWQ2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let currentView = 'login';
        let vehicles = [];
        let insurances = [];
        let maintenances = [];
        let spareParts = [];
        let vehicleTypeChart, insuranceStatusChart;

        function showView(view) {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('statsView').classList.add('hidden');
            document.getElementById('navbar').classList.add('hidden');

            if (view === 'login') {
                document.getElementById('loginView').classList.remove('hidden');
            } else {
                document.getElementById('navbar').classList.remove('hidden');
                if (view === 'dashboard') {
                    document.getElementById('dashboardView').classList.remove('hidden');
                } else if (view === 'stats') {
                    document.getElementById('statsView').classList.remove('hidden');
                    renderCharts();
                }
            }
            currentView = view;
        }

        // التحقق من حالة تسجيل الدخول
        onAuthStateChanged(auth, (user) => {
            if (user) {
                localStorage.setItem('isLoggedIn', 'true');
                showView('dashboard');
                loadData();
            } else {
                localStorage.removeItem('isLoggedIn');
                showView('login');
            }
        });

        // تسجيل الدخول
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const email = username === 'Issam' ? 'issam@symalgerie.dz' : username;
                await signInWithEmailAndPassword(auth, email, password);
                Swal.fire({
                    icon: 'success',
                    title: 'تم تسجيل الدخول',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'اسم المستخدم أو كلمة المرور غير صحيحة: ' + error.message
                });
            }
        });

        // تسجيل الخروج
        document.getElementById('logout').addEventListener('click', () => {
            signOut(auth).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'تم تسجيل الخروج',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        });

        // التنقل بين الواجهات
        document.getElementById('dashboardNav').addEventListener('click', () => showView('dashboard'));
        document.getElementById('statsNav').addEventListener('click', () => showView('stats'));

        // الوضع الليلي
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        });

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        async function loadData() {
            try {
                const vehiclesSnapshot = await get(ref(database, 'vehicles'));
                vehicles = vehiclesSnapshot.val() ? Object.entries(vehiclesSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];

                const insurancesSnapshot = await get(ref(database, 'insurances'));
                insurances = insurancesSnapshot.val() ? Object.entries(insurancesSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];

                const maintenancesSnapshot = await get(ref(database, 'maintenances'));
                maintenances = maintenancesSnapshot.val() ? Object.entries(maintenancesSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];

                const sparePartsSnapshot = await get(ref(database, 'spareParts'));
                spareParts = sparePartsSnapshot.val() ? Object.entries(sparePartsSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];

                updateVehicleSelects();
                renderTables();
                updateStats();
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء جلب البيانات: ' + error.message
                });
            }
        }

        function updateVehicleSelects() {
            const selects = [
                document.getElementById('vehicleSelect'),
                document.getElementById('maintenanceVehicleSelect'),
                document.getElementById('sparePartsVehicleSelect')
            ];
            selects.forEach(select => {
                select.innerHTML = '<option value="">اختر المركبة</option>';
                vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.plateNumber;
                    option.textContent = `${vehicle.plateNumber} (${vehicle.vehicleType})`;
                    select.appendChild(option);
                });
            });
        }

        function updateStats() {
            document.getElementById('totalVehicles').textContent = vehicles.length;
            const expiringInsurances = insurances.filter(ins => {
                const daysRemaining = getDaysRemaining(ins.endDate);
                return daysRemaining <= 7 && daysRemaining >= 0;
            }).length;
            document.getElementById('expiringInsurances').textContent = expiringInsurances;
            const upcomingMaintenances = maintenances.filter(m => {
                const mileageDiff = m.nextMileage - m.currentMileage;
                return mileageDiff <= 500;
            }).length;
            document.getElementById('upcomingMaintenances').textContent = upcomingMaintenances;
        }

        // إضافة مركبة
        document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const vehicle = {
                brand: document.getElementById('brand').value,
                model: document.getElementById('model').value,
                plateNumber: document.getElementById('plateNumber').value,
                driverName: document.getElementById('driverName').value,
                vehicleType: document.getElementById('vehicleType').value
            };

            try {
                await set(ref(database, 'vehicles/' + vehicle.plateNumber), vehicle);
                vehicles.push({ id: vehicle.plateNumber, ...vehicle });
                updateVehicleSelects();
                renderTables();
                updateStats();
                document.getElementById('vehicleForm').reset();
                Swal.fire({
                    icon: 'success',
                    title: 'تمت الإضافة',
                    text: 'تم إضافة المركبة بنجاح!'
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء إضافة المركبة: ' + error.message
                });
            }
        });

        // إضافة تأمين
        document.getElementById('insuranceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const insurance = {
                plateNumber: document.getElementById('vehicleSelect').value,
                startDate: document.getElementById('insuranceStart').value,
                endDate: document.getElementById('insuranceEnd').value
            };
            const id = Date.now().toString();

            try {
                await set(ref(database, 'insurances/' + id), insurance);
                insurances.push({ id, ...insurance });
                document.getElementById('insuranceForm').reset();
                renderTables();
                updateStats();
                Swal.fire({
                    icon: 'success',
                    title: 'تمت الإضافة',
                    text: 'تم إضافة التأمين بنجاح!'
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء إضافة التأمين: ' + error.message
                });
            }
        });

        // إضافة صيانة زيت
        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const maintenance = {
                plateNumber: document.getElementById('maintenanceVehicleSelect').value,
                oilChangeDate: document.getElementById('oilChangeDate').value,
                currentMileage: parseInt(document.getElementById('currentMileage').value),
                nextMileage: parseInt(document.getElementById('nextMileage').value)
            };
            const id = Date.now().toString();

            try {
                await set(ref(database, 'maintenances/' + id), maintenance);
                maintenances.push({ id, ...maintenance });
                document.getElementById('maintenanceForm').reset();
                renderTables();
                updateStats();
                Swal.fire({
                    icon: 'success',
                    title: 'تمت الإضافة',
                    text: 'تم إضافة سجل صيانة الزيت بنجاح!'
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء إضافة الصيانة: ' + error.message
                });
            }
        });

        // إضافة صيانة قطع غيار
        document.getElementById('sparePartsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sparePart = {
                plateNumber: document.getElementById('sparePartsVehicleSelect').value,
                sparePartsDate: document.getElementById('sparePartsDate').value,
                sparePartsNote: document.getElementById('sparePartsNote').value
            };
            const id = Date.now().toString();

            try {
                await set(ref(database, 'spareParts/' + id), sparePart);
                spareParts.push({ id, ...sparePart });
                document.getElementById('sparePartsForm').reset();
                renderTables();
                Swal.fire({
                    icon: 'success',
                    title: 'تمت الإضافة',
                    text: 'تم إضافة سجل صيانة قطع الغيار بنجاح!'
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء إضافة قطع الغيار: ' + error.message
                });
            }
        });

        // حذف مركبة
        window.deleteVehicle = async function(id) {
            const vehicle = vehicles.find(v => v.id === id);
            if (!vehicle) return;

            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: `سيتم حذف المركبة ${vehicle.plateNumber} وجميع البيانات المرتبطة بها!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف!',
                cancelButtonText: 'إلغاء'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await remove(ref(database, 'vehicles/' + id));
                        vehicles = vehicles.filter(v => v.id !== id);
                        insurances = insurances.filter(i => i.plateNumber !== vehicle.plateNumber);
                        maintenances = maintenances.filter(m => m.plateNumber !== vehicle.plateNumber);
                        spareParts = spareParts.filter(s => s.plateNumber !== vehicle.plateNumber);

                        await Promise.all([
                            ...insurances.map(i => remove(ref(database, 'insurances/' + i.id))),
                            ...maintenances.map(m => remove(ref(database, 'maintenances/' + m.id))),
                            ...spareParts.map(s => remove(ref(database, 'spareParts/' + s.id)))
                        ]);

                        updateVehicleSelects();
                        renderTables();
                        updateStats();
                        Swal.fire('تم الحذف!', 'تم حذف المركبة بنجاح.', 'success');
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'حدث خطأ أثناء الحذف: ' + error.message
                        });
                    }
                }
            });
        };

        // تعديل مركبة
        window.editVehicle = function(id) {
            const vehicle = vehicles.find(v => v.id === id);
            if (!vehicle) return;

            Swal.fire({
                title: 'تعديل المركبة',
                html: `
                    <input id="editBrand" class="swal2-input" value="${vehicle.brand}" placeholder="العلامة">
                    <input id="editModel" class="swal2-input" value="${vehicle.model}" placeholder="النوع">
                    <input id="editPlateNumber" class="swal2-input" value="${vehicle.plateNumber}" placeholder="رقم التسجيل">
                    <input id="editDriverName" class="swal2-input" value="${vehicle.driverName}" placeholder="اسم السائق">
                    <select id="editVehicleType" class="swal2-select">
                        <option value="سيارة" ${vehicle.vehicleType === 'سيارة' ? 'selected' : ''}>سيارة</option>
                        <option value="شاحنة" ${vehicle.vehicleType === 'شاحنة' ? 'selected' : ''}>شاحنة</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                preConfirm: async () => {
                    const updatedVehicle = {
                        brand: document.getElementById('editBrand').value,
                        model: document.getElementById('editModel').value,
                        plateNumber: document.getElementById('editPlateNumber').value,
                        driverName: document.getElementById('editDriverName').value,
                        vehicleType: document.getElementById('editVehicleType').value
                    };

                    try {
                        await set(ref(database, 'vehicles/' + id), updatedVehicle);
                        const index = vehicles.findIndex(v => v.id === id);
                        vehicles[index] = { id, ...updatedVehicle };
                        updateVehicleSelects();
                        renderTables();
                        Swal.fire('تم التعديل!', 'تم تعديل المركبة بنجاح.', 'success');
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'حدث خطأ أثناء التعديل: ' + error.message
                        });
                    }
                }
            });
        };

        // تعديل صيانة الزيت
        window.editMaintenance = function(id) {
            const maintenance = maintenances.find(m => m.id === id);
            if (!maintenance) return;

            Swal.fire({
                title: 'تعديل صيانة الزيت',
                html: `
                    <select id="editMaintenancePlate" class="swal2-select">
                        <option value="">اختر المركبة</option>
                        ${vehicles.map(v => `<option value="${v.plateNumber}" ${maintenance.plateNumber === v.plateNumber ? 'selected' : ''}>${v.plateNumber} (${v.vehicleType})</option>`).join('')}
                    </select>
                    <input id="editOilChangeDate" type="date" class="swal2-input" value="${maintenance.oilChangeDate}">
                    <input id="editCurrentMileage" type="number" class="swal2-input" value="${maintenance.currentMileage}" placeholder="عداد المركبة الحالي (كم)">
                    <input id="editNextMileage" type="number" class="swal2-input" value="${maintenance.nextMileage}" placeholder="عداد التغيير القادم (كم)">
                `,
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                preConfirm: async () => {
                    const updatedMaintenance = {
                        plateNumber: document.getElementById('editMaintenancePlate').value,
                        oilChangeDate: document.getElementById('editOilChangeDate').value,
                        currentMileage: parseInt(document.getElementById('editCurrentMileage').value),
                        nextMileage: parseInt(document.getElementById('editNextMileage').value)
                    };

                    try {
                        await set(ref(database, 'maintenances/' + id), updatedMaintenance);
                        const index = maintenances.findIndex(m => m.id === id);
                        maintenances[index] = { id, ...updatedMaintenance };
                        renderTables();
                        updateStats();
                        Swal.fire('تم التعديل!', 'تم تعديل صيانة الزيت بنجاح.', 'success');
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'حدث خطأ أثناء التعديل: ' + error.message
                        });
                    }
                }
            });
        };

        // تعديل قطع غيار
        window.editSparePart = function(id) {
            const sparePart = spareParts.find(s => s.id === id);
            if (!sparePart) return;

            Swal.fire({
                title: 'تعديل صيانة قطع غيار',
                html: `
                    <select id="editSparePartPlate" class="swal2-select">
                        <option value="">اختر المركبة</option>
                        ${vehicles.map(v => `<option value="${v.plateNumber}" ${sparePart.plateNumber === v.plateNumber ? 'selected' : ''}>${v.plateNumber} (${v.vehicleType})</option>`).join('')}
                    </select>
                    <input type="date" id="editSparePartsDate" class="swal2-input" value="${sparePart.sparePartsDate}">
                    <input type="text" id="editSparePartsNote" class="swal2-input" value="${sparePart.sparePartsNote}" placeholder="ملاحظة">
                `,
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                preConfirm: async () => {
                    const updatedSparePart = {
                        plateNumber: document.getElementById('editSparePartPlate').value,
                        sparePartsDate: document.getElementById('editSparePartsDate').value,
                        sparePartsNote: document.getElementById('editSparePartsNote').value
                    };

                    try {
                        await set(ref(database, 'spareParts/' + id), updatedSparePart);
                        const index = spareParts.findIndex(s => s.id === id); 
                        spareParts[index] = { id, ...updatedSparePart };
                        renderTables();
                        Swal.fire('تم التعديل!', 'تم تعديل سجل قطع الغيار بنجاح.', 'success');
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'حدث خطأ أثناء التعديل: ' + error.message
                        });
                    }
                }
            });
        };

        // حساب الأيام المتبقية
        function getDaysRemaining(endDate) {
            const today = new Date();
            const end = new Date(endDate);
            const diffTime = end - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // تصدير إلى Excel
        document.getElementById('exportExcel').addEventListener('click', () => {
            const vehicleData = vehicles.map(vehicle => {
                const insurance = insurances.find(ins => ins.plateNumber === vehicle.plateNumber);
                const maintenance = maintenances.filter(m => m.plateNumber === vehicle.plateNumber);
                const sparePart = spareParts.filter(s => s.plateNumber === vehicle.plateNumber);
                return {
                    'العلامة': vehicle.brand,
                    'النوع': vehicle.model,
                    'رقم التسجيل': vehicle.plateNumber,
                    'السائق': vehicle.driverName,
                    'نوع المركبة': vehicle.vehicleType,
                    'تاريخ بداية التأمين': insurance ? insurance.startDate : '-',
                    'تاريخ نهاية التأمين': insurance ? insurance.endDate : '-',
                    'الأيام المتبقية': insurance ? getDaysRemaining(insurance.endDate) : '-',
                    'حالة التأمين': insurance ? (getDaysRemaining(insurance.endDate) <= 0 ? 'منتهي' : getDaysRemaining(insurance.endDate) <= 7 ? 'قريب من الانتهاء' : 'فعال') : '-',
                    'تاريخ تغيير الزيت': maintenance.length ? maintenance.map(m => m.oilChangeDate).join(', ') : '-',
                    'عداد المركبة (كم)': maintenance.length ? maintenance.map(m => m.currentMileage).join(', ') : '-',
                    'عداد التغيير القادم (كم)': maintenance.length ? maintenance.map(m => m.nextMileage).join(', ') : '-',
                    'تاريخ صيانة قطع الغيار': sparePart.length ? sparePart.map(s => s.sparePartsDate).join(', ') : '-',
                    'ملاحظة قطع الغيار': sparePart.length ? sparePart.map(s => s.sparePartsNote).join(', ') : '-'
                };
            });

            const worksheet = XLSX.utils.json_to_sheet(vehicleData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Vehicles Data');
            XLSX.writeFile(workbook, 'vehicles_data.xlsx');
        });

        // فلترة الجداول
        document.getElementById('vehicleSearch').addEventListener('input', () => renderTables());
        document.getElementById('maintenanceSearch').addEventListener('input', () => renderTables());
        document.getElementById('sparePartsSearch').addEventListener('input', () => renderTables());

        function renderTables() {
            const vehicleSearch = document.getElementById('vehicleSearch').value.toLowerCase();
            const maintenanceSearch = document.getElementById('maintenanceSearch').value.toLowerCase();
            const sparePartsSearch = document.getElementById('sparePartsSearch').value.toLowerCase();

            // جدول المركبات
            const vehiclesTableBody = document.getElementById('vehiclesTableBody');
            vehiclesTableBody.innerHTML = '';
            vehicles.filter(v => v.plateNumber.toLowerCase().includes(vehicleSearch)).forEach(vehicle => {
                const insurance = insurances.find(ins => ins.plateNumber === vehicle.plateNumber);
                const row = document.createElement('tr');
                let daysRemaining = '-';
                let status = '-';

                if (insurance) {
                    daysRemaining = getDaysRemaining(insurance.endDate);
                    if (daysRemaining <= 0) {
                        status = 'منتهي';
                        row.classList.add('expired');
                    } else if (daysRemaining <= 7) {
                        status = 'قريب من الانتهاء';
                        row.classList.add('warning');
                    } else {
                        status = 'فعال';
                    }
                }

                row.innerHTML = `
                    <td class="p-3">${vehicle.brand}</td>
                    <td class="p-3">${vehicle.model}</td>
                    <td class="p-3">${vehicle.plateNumber}</td>
                    <td class="p-3">${vehicle.driverName}</td>
                    <td class="p-3">${vehicle.vehicleType}</td>
                    <td class="p-3">${insurance ? insurance.startDate : '-'}</td>
                    <td class="p-3">${insurance ? insurance.endDate : '-'}</td>
                    <td class="text-center p-3">${daysRemaining}</td>
                    <td class="text-center p-3">${status}</td>
                    <td class="p-3">
                        <button onclick="editVehicle('${vehicle.id}')"><i class="fas fa-edit mr-2"></i></button>
                        <button onclick="deleteVehicle('${vehicle.id}')"><i class="fas fa-trash text-red-600"></i></button>
                    </td>
                `;
                vehiclesTableBody.appendChild(row);
            });

            // جدول صيانة الزيوت
            const maintenanceTableBody = document.getElementById('maintenanceTableBody');
            maintenanceTableBody.innerHTML = '';
            maintenances.filter(m => m.plateNumber.toLowerCase().includes(maintenanceSearch)).forEach(maintenance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-3">${maintenance.plateNumber}</td>
                    <td class="p-3">${maintenance.oilChangeDate}</td>
                    <td class="p-3">${maintenance.currentMileage}</td>
                    <td class="p-3">${maintenance.nextMileage}</td>
                    <td class="p-3">
                        <button onclick="editMaintenance('${maintenance.id}')"><i class="fas fa-edit mr-2"></i></button>
                        <button onclick="deleteMaintenance('${maintenance.id}')"><i class="fas fa-trash text-red-600"></i></button>
                    </td>
                `;
                maintenanceTableBody.appendChild(row);
            });

            // جدول قطع الغيار
            const sparePartsTableBody = document.getElementById('sparePartsTableBody');
            sparePartsTableBody.innerHTML = '';
            spareParts.filter(s => s.plateNumber.toLowerCase().includes(sparePartsSearch)).forEach(sparePart => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-3">${sparePart.plateNumber}</td>
                    <td class="p-3">${sparePart.sparePartsDate}</td>
                    <td class="p-3">${sparePart.sparePartsNote}</td>
                    <td class="p-3">
                        <button onclick="editSparePart('${sparePart.id}')"><i class="fas fa-edit mr-2"></i></button>
                        <button onclick="deleteSparePart('${sparePart.id}')"><i class="fas fa-trash text-red-600"></i></button>
                    </td>
                `;
                sparePartsTableBody.appendChild(row);
            });
        }

        // حذف صيانة زيت
        window.deleteMaintenance = async function(id) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم حذف سجل صيانة الزيت!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف!',
                cancelButtonText: 'إلغاء'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await remove(ref(database, 'maintenances/' + id));
                        maintenances = maintenances.filter(m => m.id !== id);
                        renderTables();
                        updateStats();
                        Swal.fire('تم الحذف!', 'تم حذف سجل الصيانة بنجاح.', 'success');
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'حدث خطأ أثناء الحذف: ' + error.message
                        });
                    }
                }
            });
        };

        // حذف قطع غيار
        window.deleteSparePart = async function(id) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم حذف سجل قطع الغيار!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف!',
                cancelButtonText: 'إلغاء'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await remove(ref(database, 'spareParts/' + id));
                        spareParts = spareParts.filter(s => s.id !== id);
                        renderTables();
                        Swal.fire('تم الحذف!', 'تم حذف تسجيل قطع الغيار بنجاح.', 'success');
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'حدث خطأ أثناء الحذف: ' + error.message
                        });
                    }
                }
            });
        };

        // عرض الرسوم البيانية
        function renderCharts() {
            if (vehicleTypeChart) vehicleTypeChart.destroy();
            if (insuranceStatusChart) insuranceStatusChart.destroy();

            // رسم بياني لعدد المركبات حسب النوع
            const vehicleTypes = vehicles.reduce((acc, v) => {
                acc[v.vehicleType] = (acc[v.vehicleType] || 0) + 1;
                return acc;
            }, {});

            vehicleTypeChart = new Chart(document.getElementById('vehicleTypeChart'), {
                type: 'bar',
                data: {
                    labels: ['سيارة', 'شاحنة'],
                    datasets: [{
                        label: 'عدد المركبات',
                        data: [vehicleTypes['سيارة'] || 0, vehicleTypes['شاحنة'] || 0],
                        backgroundColor: ['#3498db', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'عدد المركبات حسب النوع' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // رسم بياني لحالة التأمينات
            const insuranceStatus = {
                active: 0,
                expiringSoon: 0,
                expired: 0
            };

            insurances.forEach(ins => {
                const daysRemaining = getDaysRemaining(ins.endDate);
                if (daysRemaining <= 0) {
                    insuranceStatus.expired++;
                } else if (daysRemaining <= 7) {
                    insuranceStatus.expiringSoon++;
                } else {
                    insuranceStatus.active++;
                }
            });

            insuranceStatusChart = new Chart(document.getElementById('insuranceStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['فعال', 'قريب من الانتهاء', 'منتهي'],
                    datasets: [{
                        label: 'حالة التأمين',
                        data: [insuranceStatus.active, insuranceStatus.expiringSoon, insuranceStatus.expired],
                        backgroundColor: ['#2ecc71', '#f1c40f', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'حالة التأمينات' }
                    }
                }
            });
        }
    </script>
</body>
</html>
